<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Horário</title>
  <link rel="stylesheet" href="assets/css/horario.css">
</head>
<body>
  <div class="form-container">
    <div class="form-image">
      <img id="service-image" src="" alt="Imagem do Serviço">
    </div>

    <div class="form-price">
      <p id="service-price"></p>
    </div>

    <form id="contact-form">
      <h2>Formulário de Agendamento</h2>

      <label for="nome">Nome:</label>
      <input type="text" id="nome" name="nome" required>

      <label for="sobrenome">Sobrenome:</label>
      <input type="text" id="sobrenome" name="sobrenome" required>

      <label for="numero">Número:</label>
      <input type="tel" id="numero" name="numero" placeholder="(xx) xxxxx-xxxx" required>

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>

      <div class="datetime-group">
        <div>
          <label for="data">Data:</label>
          <input type="date" id="data" name="data" required>
        </div>
        <div>
          <label for="hora">Hora:</label>
          <input type="time" id="hora" name="hora" required>
        </div>
      </div>

      <button type="submit">Enviar</button>
    </form>
  </div>

<script>
// ======== LISTA DE FERIADOS NACIONAIS (fixos) ========
const feriadosFixos = [
  "01-01", "04-21", "05-01", "09-07",
  "10-12", "11-02", "11-15", "12-25"
];

function isFeriado(date) {
  const mes = String(date.getMonth() + 1).padStart(2, "0");
  const dia = String(date.getDate()).padStart(2, "0");
  return feriadosFixos.includes(`${mes}-${dia}`);
}

// ======== Função para obter parâmetros da URL ========
function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// ======== GERA HORÁRIOS DE 30 EM 30 MINUTOS ========
function gerarOpcoesHorario(min, max) {
  const horaInput = document.getElementById('hora');
  horaInput.innerHTML = ""; // limpa opções

  let [h, m] = min.split(":").map(Number);
  const [maxH, maxM] = max.split(":").map(Number);

  while (h < maxH || (h === maxH && m <= maxM)) {
    const horaStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    const option = document.createElement("option");
    option.value = horaStr;
    option.textContent = horaStr;
    horaInput.appendChild(option);

    m += 30;
    if (m >= 60) {
      m = 0;
      h++;
    }
  }
}

// ======== CONFIGURAÇÃO DE DATA ========
function configurarAgendamento() {
  const dataInput = document.getElementById('data');
  const horaInput = document.getElementById('hora');

  const agora = new Date();
  const anoAtual = agora.getFullYear();

  const minData = agora.toISOString().split("T")[0];
  const maxData = `${anoAtual + 1}-12-31`;

  dataInput.min = minData;
  dataInput.max = maxData;
  dataInput.value = minData;

  dataInput.addEventListener('change', function () {
    const dataSelecionada = new Date(this.value);
    const diaSemana = dataSelecionada.getDay();

    // Domingo ou feriado bloqueado
    if (diaSemana === 0 || isFeriado(dataSelecionada)) {
      alert("Não é possível agendar em domingos ou feriados.");
      this.value = "";
      horaInput.innerHTML = "";
      return;
    }

    // Segunda a sexta
    if (diaSemana >= 1 && diaSemana <= 5) {
      gerarOpcoesHorario("07:00", "19:00");
    }

    // Sábado
    else if (diaSemana === 6) {
      gerarOpcoesHorario("07:00", "14:00");
    }
  });

  // Carregar horários para hoje
  const diaHoje = agora.getDay();
  if (diaHoje >= 1 && diaHoje <= 5) gerarOpcoesHorario("07:00", "19:00");
  else if (diaHoje === 6) gerarOpcoesHorario("07:00", "14:00");
}

// ======== VALIDAÇÃO FINAL DO FORMULÁRIO ========
function validarEEnviarFormulario() {
  const form = document.getElementById('contact-form');

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const nome = document.getElementById('nome').value.trim();
    const sobrenome = document.getElementById('sobrenome').value.trim();
    const numero = document.getElementById('numero').value.trim();
    const email = document.getElementById('email').value.trim();
    const data = document.getElementById('data').value;
    const hora = document.getElementById('hora').value;

    if (!nome || !sobrenome || !numero || !email || !data || !hora) {
      alert("Preencha todos os campos.");
      return;
    }

    const agora = new Date();
    const dataSelecionada = new Date(`${data}T${hora}`);
    const anoAtual = agora.getFullYear();

    if (dataSelecionada < agora) {
      alert("Não é possível agendar no passado.");
      return;
    }

    if (dataSelecionada.getFullYear() > anoAtual + 1) {
      alert("Ano inválido para agendamento.");
      return;
    }

    // VALIDAÇÃO EXTRA – horário fora da lista NÃO passa
    const horariosPermitidos = [...document.getElementById('hora').options].map(o => o.value);
    if (!horariosPermitidos.includes(hora)) {
      alert("Horário inválido! Apenas horários de 30 em 30 minutos são permitidos.");
      return;
    }

    // Domingo/feriado (extra)
    if (dataSelecionada.getDay() === 0 || isFeriado(dataSelecionada)) {
      alert("Não é possível agendar em domingos ou feriados.");
      return;
    }

    // ============================
    // SALVAR AGENDAMENTO
    // ============================
    const agendamento = {
      nome,
      sobrenome,
      numero,
      email,
      data,
      hora,
      imagem: getUrlParameter('img'),
      preco: getUrlParameter('preco')
    };

    localStorage.setItem('agendamento', JSON.stringify(agendamento));

    // ============================
    // ADICIONAR AO CARRINHO
    // ============================
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];

    const itemCarrinho = {
      id: Date.now(),
      nome: `Agendamento - ${agendamento.data} ${agendamento.hora}`,
      imagem: agendamento.imagem,
      preco: Number(agendamento.preco),
      quantidade: 1
    };

    carrinho.push(itemCarrinho);
    localStorage.setItem("carrinho", JSON.stringify(carrinho));

    // Redireciona
    window.location.href = "checkout.html";
  });
}

// ======== INICIAR ========
window.onload = function () {
  const imageUrl = getUrlParameter('img');
  const price = getUrlParameter('preco');

  if (imageUrl) document.getElementById('service-image').src = imageUrl;
  if (price) document.getElementById('service-price').textContent = `Preço: R$ ${price}`;

  configurarAgendamento();
  validarEEnviarFormulario();
};
</script>

</body>
</html>
